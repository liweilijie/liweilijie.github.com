<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>liwei.tk</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="李伟">
		<meta name="author" content="李伟的维基">

		<!-- Le styles -->
		<link href="assets/css/bootstrap.css" rel="stylesheet">
		<link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
		<!-- display by liw for the padding at the top <link href="assets/css/docs.css" rel="stylesheet">-->
		<link href="assets/css/docs.css" rel="stylesheet">
		<link href="assets/js/google-code-prettify/prettify.css" rel="stylesheet">

		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->

		<!-- Le fav and touch icons -->
		<link rel="shortcut icon" href="../assets/ico/favicon.ico">
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
		<link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">
		
		<link type="text/css" rel="stylesheet" href="syntaxhighlighter/css/shCore.css" /> 
		<link type="text/css" rel="stylesheet" href="syntaxhighlighter/css/shThemeRDark.css" /> 
		<script type="text/javascript" src="syntaxhighlighter/js/shCore.js"></script> 
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPython.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushBash.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushCpp.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPowerShell.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushXml.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPlain.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushSql.js"></script>
		<script type="text/javascript">
			SyntaxHighlighter.defaults['gutter'] = true;
			SyntaxHighlighter.all();
			</script> 
			
		<!-- add the google analytics -->
		<script type="text/javascript">

			var _gaq = _gaq || [];
			_gaq.push(['_setAccount', 'UA-25233855-1']);
			_gaq.push(['_trackPageview']);

			(function() {
			 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
			 })();

		 </script>

	</head>

	<body data-spy="scroll" data-target=".subnav" data-offset="50">

		<!-- <div class="span10 well pricehover">-->

		<!-- ==================== start navbar ================== -->
			<div class="navbar">
				<div class="navbar-inner">
					<div class="container-fuid">
					<!-- old is : <div class="container"> and fixed by to 'fuid style' -->
						<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</a>
						<a class="brand" href="#">Liwei.tk</a>
						<div class="nav-collapse">
							<ul class="nav">
								<li class="active"><a href="index.html">Home</a></li>
								<!-- Program sub projects  -->
								<li class="dropdown">
								<a href="index.html#" class="dropdown-toggle" data-toggle="dropdown">Programs <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="c.html">C</a></li>
									<li><a href="cpp.html">Cpp</a></li>
									<li><a href="shell.html">Shell</a></li>
									<li class="divider"></li>
									<li class="nav-header">Others</li>
									<li><a href="python.html">Python</a></li>
									<li><a href="expect.html">Expect</a></li>
									<li><a href="vc.html">Vc</a></li>
								</ul>
								</li>
								<!-- Os sub projects  -->
								<li class="dropdown">
								<a href="index.html#" class="dropdown-toggle" data-toggle="dropdown">Os <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="linux.html">Linux</a></li>
									<li class="divider"></li>
									<li><a href="windows.html">Windows</a></li>
								</ul>
								</li>

								<!-- vim -->
								<li><a href="vim.html">Vim</a></li>
								<li><a href="#">Link</a></li>
								<li><a href="#">Link</a></li>
								<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="#">Action</a></li>
									<li><a href="#">Another action</a></li>
									<li><a href="#">Something else here</a></li>
									<li class="divider"></li>
									<li class="nav-header">Nav header</li>
									<li><a href="#">Separated link</a></li>
									<li><a href="#">One more separated link</a></li>
								</ul>
								</li>
							</ul>
							<form class="navbar-search pull-left" action="">
								<input type="text" class="search-query span2" placeholder="Search">
							</form>
							<ul class="nav pull-right">
								<li><a href="#">Link</a></li>
								<li class="divider-vertical"></li>
								<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">随记<b class="caret"></b></a>
								<ul class="dropdown-menu">
									<li><a href="article_by_my_heart.html">随心所欲</a></li>
									<li><a href="article_reading_notes.html">读书札记</a></li>
									<li><a href="article_love_music.html">最爱音乐</a></li>
									<li class="divider"></li>
									<li><a href="#">日记</a></li>
								</ul>
								</li>
							</ul>
						</div><!-- /.nav-collapse -->
					</div>
				</div><!-- /navbar-inner -->
			</div><!-- /navbar -->
		<!--</div>-->

	<div class="container">

		<!--span2 + span10 that's really content-->
		<div class="row">
			<div class="span10" data-spy="scroll" >
				<div class="gsearch"></div>
				<div class="content">
					
<h1>expect 自动运行命令</h1>

<hr />

<p>
最近做升级有关的东西，但是在代码里面有一个很低级的错误。
</p>

<p>
也就是文件打开了没有关闭，由于从其他同事那儿接过来的代码，本来运行很稳定的，所以也就没有检查是否有问题。
</p>

<p>
最后导致太多的设备不能正常升级。于是我写了一个脚本一个一个自动登陆到设备上，进行替换模块。
</p>

<hr />

<ul>
<li>
首先是login.sh脚本，它主要是将配置文件里面的所有ip地址读进来，然后转化为点分十进制式的ip,调用expect脚本进行操作。

</ul>

<pre class="brush:bash;">
#!/bin/bash
#author: liw
#create time:2011-06-16
if [ -z "$1" ]
then
	echo "sh login.sh ./ip.tbl $0 $1 ";
	exit;
fi
ssh_user="mat"
ssh_port="22";
ssh_password="H192g213"
ip_file=$1
if [ ! -e "$ip_file" ]
then
	echo "$ip_file is not exists";
	exit;
fi
account=0
for i in `cat $ip_file`
do
	if [ "X$i" != "X0" -a ! -z $i ]
	then
		account=$account+1
		ssh_host=`client -i $i|awk '{print $2}'`
		#echo ".......[${account}]:[$i]=&gt;[$ssh_host]................."
		#echo "["`date +"%F %T"`"] (ssh  $ssh_user@$ssh_host &amp;&amp; passwd:$ssh_password) start"
		/usr/bin/expect action.sh "$ssh_host" "$ssh_port" "$ssh_user" "$ssh_password"
		#echo "["`date +"%F %T"`"] (ssh $ssh_user@$ssh_host end"
		#echo ""
	fi
done
echo "process all done."
</pre>

<hr />

<ul>
<li>
接着是back.action.sh脚本。 它是真正的expect脚本，它将两次登陆。

</ul>

<pre class="brush:bash;">
#!/usr/bin/expect
#author: liw
set scphost "[lindex $argv 0]"
set port "[lindex $argv 1]"
set scpuser "[lindex $argv 2]"
set scppw "[lindex $argv 3]"
set passwd_x86 "x86"
set passwd_arm "arm"
set timeout 10
send_user "\nssh $scpuser@$scphost\n"
spawn ssh $scpuser@$scphost
expect {
-re ".*Are.*.*yes.*no.*" {
send "yes\n"
exp_continue
}
"*?assword:*" {
set timeout 15
send $scppw
send "\n"
exp_continue
}
"2......*设备状态*" {
set timeout 15
send_user "..................get the qzt status.......\n"
send "2\n"
exp_continue
}
"14................查看设备硬盘信息*" {
set timeout 15
sleep 1
send_user "\n....................get harddisk info.......\n"
send "14\n"
send_user "......send to 14......................................\n"
exp_continue
}
"*16.....*硬盘信息*" {
set timeout 15
sleep 1
send_user "\n....................get harddisk info.......\n"
send "16\n"
#puts "ppppppppppppppppp $expect_out(buffer)"
exp_continue
}

"*硬盘*号*" {
set timeout 15
send_user "\n....................get harddisk sequnce number success success .......\n"
puts "ppppppppppppppppp $expect_out(buffer)"
#set haha [exec date]
#set harddisk_seq [exec sh -c "echo $expect_out(buffer) | sed {s/.*\^\{1,\}\(.*\)\].*/\1/g}"]
set harddisk_seq [exec echo $expect_out(buffer) | sed -n {s/.*\^\{1,\}\(.*\)\].*/\1/gp}]
set passwd_x86 [exec curl -s -d "hd_sn=$harddisk_seq&amp;qzt_type=x86" http://192.168.3.208/getkey.do | sed -n {s/.*&lt;pass&gt;\(.*\)&lt;\/pass&gt;.*/\1/gp}]
set passwd_arm [exec curl -s -d "hd_sn=$harddisk_seq&amp;qzt_type=arm" http://192.168.3.208/getkey.do | sed -n {s/.*&lt;pass&gt;\(.*\)&lt;\/pass&gt;.*/\1/gp}]
#puts "exec curl -s -d {hd_sn=${harddisk_seq}&amp;qzt_type=x86} http://192.168.3.208/getkey.do | sed -n {s/.*&lt;pass&gt;\(.*\)&lt;\/pass&gt;.*/\1/gp}"
#puts "[exec curl -s -d {hd_sn=$harddisk_seq&amp;qzt_type=x86} http://192.168.3.208/getkey.do]"
#set harddisk_seq [exec echo www.baidu.com | sed {s/.*\.\(.*\)\..*/\1/g}]
puts "phhhhhhhhhhhhhhh $harddisk_seq"
puts "x86 hhhhhhhhhhhhhhh $passwd_x86"
puts "arm hhhhhhhhhhhhhhh $passwd_x86"
#puts [exec echo {$passwd_x86} &gt; t.tt]
#puts [exec echo "$passwd_x86" &gt; t.tt]

}

}
send_user "over......................................\n"
close $spawn_id

if {$passwd_x86 != "x86"} {
	spawn ssh root@$scphost
	expect {
	-re ".*Are.*.*yes.*no.*" {
	send "yes\n"
	exp_continue
}
"*?assword:*" {
set timeout 15
# 记住这里的'\r' 与'\n'的不一样，打印时用'\n',而在发送命令回车时用：'\r'
send "$passwd_x86\r"
send "\r"
send_user "success x86 $passwd_x86\n"
expect {
-re ".*Permission.*" {
set timeout 5
send "$passwd_arm\r"
send "\r"
send_user "sned arm $passwd_arm\n"
exp_continue
}
".*]#*" {
set timeout 10
send "df -lh\r"
send "cat /etc/config_issue\r"
send "lsof -p `pidof beap_eupdate`\r"
send "kill -KILL `pidof beap_eupdate`\r"
send "killall -9 beap_eupdate\r"
send "exit\r"
}
}
exp_continue
}
}
}

exit 0
</pre>

<hr />

<ul>
<li>
由于mat登陆得到的中文信息是gbk的，而脚本在写时利用了utf-8的，所以要将utf-8编码转为gbk的编码运行才行。
<br />	<code>iconv -f UTF-8 -t GBK back.action.sh &gt; action.sh</code>

</ul>

<p>
最后运行：<code>./login ./debug_ip.txt</code>
</p>

<hr />

				</div>
			</div>
		</div> <!-- really content end -->
		<div class="row footer">
			<hr />
			<a href="index.html">首页</a>
			<a href="#"> | 关于</a>
			<a href="#"> | 链接</a>
			<a href="#"> | 链接</a>
		</div>

	</div>

		<!-- Le javascript ================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		<!-- display by liw <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>-->
		<!--<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>-->
		<script src="assets/js/jquery.js"></script>
		<script src="assets/js/liwei.js"></script>
		<script src="assets/js/google-code-prettify/prettify.js"></script>
		<script src="assets/js/bootstrap-transition.js"></script>
		<script src="assets/js/bootstrap-alert.js"></script>
		<script src="assets/js/bootstrap-modal.js"></script>
		<script src="assets/js/bootstrap-dropdown.js"></script>
		<script src="assets/js/bootstrap-scrollspy.js"></script>
		<script src="assets/js/bootstrap-tab.js"></script>
		<script src="assets/js/bootstrap-tooltip.js"></script>
		<script src="assets/js/bootstrap-popover.js"></script>
		<script src="assets/js/bootstrap-button.js"></script>
		<script src="assets/js/bootstrap-collapse.js"></script>
		<script src="assets/js/bootstrap-carousel.js"></script>
		<script src="assets/js/bootstrap-typeahead.js"></script>
		<script src="assets/js/application.js"></script>
		<script src="assets/js/liwei.js"></script>


	</body>
</html>
