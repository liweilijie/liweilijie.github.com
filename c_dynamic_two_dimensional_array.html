<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>liwei.tk</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="李伟">
		<meta name="author" content="李伟的维基">

		<!-- Le styles -->
		<link href="assets/css/bootstrap.css" rel="stylesheet">
		<link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
		<!-- display by liw for the padding at the top <link href="assets/css/docs.css" rel="stylesheet">-->
		<link href="assets/css/docs.css" rel="stylesheet">
		<link href="style.css" rel="stylesheet">
		<link href="assets/js/google-code-prettify/prettify.css" rel="stylesheet">

		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->

		<!-- Le fav and touch icons -->
		<link rel="shortcut icon" href="../assets/ico/favicon.ico">
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
		<link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">

		<link type="text/css" rel="stylesheet" href="syntaxhighlighter/css/shCore.css" /> 
		<link type="text/css" rel="stylesheet" href="syntaxhighlighter/css/shThemeRDark.css" /> 
		<script type="text/javascript" src="syntaxhighlighter/js/shCore.js"></script> 
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPython.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushBash.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushCpp.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPowerShell.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushXml.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPlain.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushSql.js"></script>
		<script type="text/javascript">
			SyntaxHighlighter.defaults['gutter'] = true;
			SyntaxHighlighter.all();
			</script> 
			
<!-- add the google analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25233855-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

		</head>

		<body data-spy="scroll" data-target=".subnav" data-offset="50">

			<!--<div class="span10 well pricehover">-->

				<!-- ==================== start navbar ================== -->
				<div class="navbar">
					<div class="navbar-inner">
						<div class="container-fuid">
							<!-- old is : <div class="container"> and fixed by to 'fuid style' -->
								<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</a>
								<a class="brand" href="#">Liwei.tk</a>
								<div class="nav-collapse">
									<ul class="nav">
										<li><a href="index.html">Home</a></li>
										<!-- Program sub projects  -->
										<li class="dropdown active">
										<a href="index.html#" class="dropdown-toggle" data-toggle="dropdown">Programs <b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="c.html">C</a></li>
											<li><a href="cpp.html">Cpp</a></li>
											<li><a href="shell.html">Shell</a></li>
											<li class="divider"></li>
											<li class="nav-header">Others</li>
											<li><a href="python.html">Python</a></li>
											<li><a href="expect.html">Expect</a></li>
											<li><a href="vc.html">Vc</a></li>
										</ul>
										</li>
										<!-- Os sub projects  -->
										<li class="dropdown">
										<a href="index.html#" class="dropdown-toggle" data-toggle="dropdown">Os <b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="linux.html">Linux</a></li>
											<li class="divider"></li>
											<li><a href="windows.html">Windows</a></li>
										</ul>
										</li>

										<!-- vim -->
										<li><a href="vim.html">Vim</a></li>
										<li><a href="#">Link</a></li>
										<li><a href="#">Link</a></li>
										<li class="dropdown">
										<a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="#">Action</a></li>
											<li><a href="#">Another action</a></li>
											<li><a href="#">Something else here</a></li>
											<li class="divider"></li>
											<li class="nav-header">Nav header</li>
											<li><a href="#">Separated link</a></li>
											<li><a href="#">One more separated link</a></li>
										</ul>
										</li>
									</ul>
									<form class="navbar-search pull-left" action="">
										<input type="text" class="search-query span2" placeholder="Search">
									</form>
									<ul class="nav pull-right">
										<li><a href="#">Link</a></li>
										<li class="divider-vertical"></li>
										<li class="dropdown">
										<a href="#" class="dropdown-toggle" data-toggle="dropdown">随记<b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="article_by_my_heart.html">随心所欲</a></li>
											<li><a href="article_reading_notes.html">读书札记</a></li>
											<li><a href="article_love_music.html">最爱音乐</a></li>
											<li class="divider"></li>
											<li><a href="#">日记</a></li>
										</ul>
										</li>
									</ul>
								</div><!-- /.nav-collapse -->
							</div>
						</div><!-- /navbar-inner -->
					</div><!-- /navbar -->
					<!--</div>-->

				<div class="container">

					<!--span2 + span10 that's really content-->
					<div class="row">

						<!--left nav-->
						<div class="span3 side-nav">
							<div class="well sidebar-nav">
								<h3><a href="c.html">C</a></h3>

								<ul class="nav nav-pills nav-stacked">
									<li class="nav-header">关于语法</li>
									<li> <a href="c_cycle_single_link.html">单循环链表的实现</a></li>
									<li> <a href="c_util_function_interfaces.html">util function interface</a></li>
									<li> <a href="c_easy_error.html">只有两行的C程序至少有80%的人会判断错</a></li>
									<li> <a href="c_variable_length_array.html">c柔性数组</a></li>
									<li> <a href="c_counting_1_bits_c_implementations.html">计数一个整数中1的个数</a>
									<li> <a href="c_memory_manager_detail.html">c内存管理</a></li>
									<li> <a href="c_sscanf_detail.html">sscanf用法</a></li>
									<li> <a href="c_sizeof_about_point.html">sizeof(指针)</a><li>
									<li><a href="c_about_userlogin_api.html">c(api)实现用户登录信息</a></li>
									<li class="nav-header">常用实例</li>
									<li> <a href="c_debug_pthread_rwlock_t.html">compile时提示缺少pthread_rwlock_t类型定义</a></li> 
									<li> <a href="c_debug_memcmp_struct.html">小心使用memcmp来比较struct</a></li>
									<li> <a href="c_do_while_replase_if.html">用do...while(0)替代if多重判断</a></li>
									<li> <a href="c_gettimeofday_backup_time.html">c利用gettimeofday得到精确时间</a></li>
									<li> <a href="c_dynamic_two_dimensional_array.html">c动态申请二维数组</a></li>
									<li> <a href="c_program_analyse_deeply.html">c语言深度剖析</a></li>
									<li> <a href="c_macro_define_collect.html">c宏定义</a></li>
									<li> <a href="c_changable_agrument.html">c可变参数</a></li>
									<li class="nav-header">常用技巧</li>
									<li> <a href="c_function_argument.html">linux c 函数参考</a></li>
									<li> <a href="c_error.html">错误处理</a></li>
									<li> <a href="c_string.h.html">string.h 函数大全</a></li>
									<li> <a href="c_rand.html">c rand()</a></li>
									<li> <a href="c_diff_memcpy_memmove.html"> memcpy() memmove() 区别</a></li>
									<li> <a href="c_iconv_match_notice.html">慎用c语言中的iconv()</a></li>
								</ul>
							</div> <!-- ...well -->
						</div> <!-- --span  -->

						<!-- right contnet -->

						<div class="span9" data-spy="scroll" >
							<div class="gsearch"></div>
							<div class="content">
								<div class="alert top-nav"><a href="index.html">首页</a>&nbsp;&gt;&nbsp;<a href="c.html">C</a></div>
								
<h1>c动态申请二维数组</h1>
<div class="toc">
<ul>
<li><a href="#toc_0.1">before</a>
<li><a href="#toc_0.2">truth</a>
<li><a href="#toc_0.3">coders</a>
<li><a href="#toc_0.4">result</a>
<li><a href="#toc_0.5">postscript</a>
</ul>
</ul>
</div>

<h2 id="toc_0.1">before</h2>
<p>
今天在看一些代码时，感觉在使用数组方面简直是相当的浪费，而不得不用多维数组。
</p>

<p>
于是就在网上 <code>放狗</code> 查找了一下是否可以动态申请二维数组呢？
</p>

<p>
呵呵……
</p>

<p>
只要我能想到的，总是可以找到的。
</p>

<p>
自己总结了一上，写了一个测试程序。记此备忘。
</p>

<h2 id="toc_0.2">truth</h2>
<p>
利用malloc在堆上申请空间，这个空间是要包括多少维的空间。
</p>

<p>
也就是 <code>总空间 = 真正的数据元素空间 ＋ 存放维数指针的空间</code>
</p>

<p>
真正存放数据的空间就是数据所存放的空间。
</p>

<p>
而存放维数的指针空间是附加的。靠这种方式进行一次跳转。
</p>

<p>
其实将类型所表示真正的涵义搞明白了就能理解它了。
</p>

<h2 id="toc_0.3">coders</h2>
<pre class="brush:c; collapse: true; highlight: [42, 51,52];">
/**
 * @file dynamic_array_new.c
 * @brief dynamic create the two-dimensional array. like this. 
 *
 * struct aaa **x;
 * x = (struct aaa **)dynamic_array_new(5, 4, sizeof(struct aaa));
 * ....
 * ...
 * ....
 * x[1][3] ... x[0][2] //to use it.
 * ....
 * dynamic_array_free(x);
 *
 * @author :liw &lt;liweilijie@gmail.com&gt;
 * @version 0.0.0.1
 * @date 2011-08-14
 */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

/**
 * @brief dynamic_array_new &lt;++&gt; dynamic create two-dimensional array.
 *
 * @param row&lt;++&gt; row of two-dimensional array.
 * @param col&lt;++&gt; col of two-dimensional array.
 * @param size&lt;++&gt; size of every member into array.
 *
 * @return : success: return array poine; fail: NULL.
 */
void **dynamic_array_new(int row, int col, int size)
{
	if (0 == size || 0 == row || 0 == col)
		return NULL;

	void **arr;

	/**
	 * malloc the memory to store the two-dimensional array members.
	 * but added the row pointer memory to pointer the every array row member  address.
	 */
	arr = (void **)malloc(sizeof(void *)*row + size * row * col);

	if (NULL != arr)
	{
		void *head;
		
		head = (void *)arr + sizeof(void *)*row; /** find the data member address. */ 
		memset(arr, 0, sizeof(void *) * row + size * row * col); /** initializal all memory . */ 

		while (row--)
			arr[row] = head + size * row * col; /** to find the every tow-dimensional array row address */ 
	}
	else
		return NULL;

	return arr;
}

/**
 * @brief dynamic_array_free &lt;++&gt; just free the malloc momery.
 *
 * @param arr&lt;++&gt; the pointer by malloc.
 */
void dynamic_array_free(void **arr)
{
	if (arr != NULL)
		free(arr);
}


/**
 * @brief main &lt;++&gt; the test coder about tow-dimensional to dynamic create.
 *
 * @param argc&lt;++&gt; NULL.
 * @param argv[]&lt;++&gt; NULL.
 *
 * @return : always 0.
 */
int main(int argc, char *argv[])
{
	int i, j;

	struct _tt
	{
		int index; /** to pointer the two-dimensional array row */ 
		int value;  /** to store the value but this to use the col value  */ 
	};

	/** TODO(1st): malloc the two-dimensional need memory. */ 
	struct _tt **array = dynamic_array_new(5, 4, sizeof(struct _tt));

	/** TODO(2st): get the value for the every array member. */
	for (i = 0; i &lt; 5; i++)
	{
		for (j = 0; j &lt; 4; j++)
		{
			array[i][j].index = i+1;
			array[i][j].value = j+1;
		}
	}

	/** TODO(3st): print the every value like array. */
	for (i = 0; i &lt; 5; i++)
	{
		for (j = 0; j &lt; 4; j++)
		{
			printf("ray[%d][%d].index=%1d ", i, j, array[i][j].index);
			printf("ray[%d][%d].value=%1d ", i, j, array[i][j].value);
		}
		printf("\n");
	}
	
	/** TODO(4st): free the memory while program is exiting due to it is heep. */
	dynamic_array_free(array);

	return 0;
}
</pre>

<h2 id="toc_0.4">result</h2>
<pre class="brush:bash; collapse: true; highlight: [9, 10, 11, 12, 13];">
liwei@liweilijie test$ ls
dynamic_array_new.c
liwei@liweilijie test$ gcc -Wall -g -o dynamic_array_new dynamic_array_new.c 
dynamic_array_new.c: 在函数‘main’中:
dynamic_array_new.c:91:23: 警告：从不兼容的指针类型初始化 [默认启用]
dynamic_array_new.c:115:2: 警告：传递‘dynamic_array_free’的第 1 个参数时在不兼容的指针类型间转换 [默认启用]
dynamic_array_new.c:65:6: 附注：需要类型‘void **’，但实参的类型为‘struct _tt **’
liwei@liweilijie test$ ./dynamic_array_new 
ray[0][0].index=1 ray[0][0].value=1 ray[0][1].index=1 ray[0][1].value=2 ray[0][2].index=1 ray[0][2].value=3 ray[0][3].index=1 ray[0][3].value=4 
ray[1][0].index=2 ray[1][0].value=1 ray[1][1].index=2 ray[1][1].value=2 ray[1][2].index=2 ray[1][2].value=3 ray[1][3].index=2 ray[1][3].value=4 
ray[2][0].index=3 ray[2][0].value=1 ray[2][1].index=3 ray[2][1].value=2 ray[2][2].index=3 ray[2][2].value=3 ray[2][3].index=3 ray[2][3].value=4 
ray[3][0].index=4 ray[3][0].value=1 ray[3][1].index=4 ray[3][1].value=2 ray[3][2].index=4 ray[3][2].value=3 ray[3][3].index=4 ray[3][3].value=4 
ray[4][0].index=5 ray[4][0].value=1 ray[4][1].index=5 ray[4][1].value=2 ray[4][2].index=5 ray[4][2].value=3 ray[4][3].index=5 ray[4][3].value=4 
liwei@liweilijie test$ 

</pre>

<h2 id="toc_0.5">postscript</h2>
<p>
其实上面的例子是一个很经典的技巧，也很容易想到，也可以这样来理解这个例子。
</p>

<pre class="brush:c; collapse:true">
/**
 * @file d_n.c
 * @brief dynamic create the two-dimensional array. like this. 
 *
 * struct aaa **x;
 * x = (struct aaa **)dynamic_array_new(5, 4, sizeof(struct aaa));
 * ....
 * ...
 * ....
 * x[1][3] ... x[0][2] //to use it.
 * ....
 * dynamic_array_free(x);
 *
 * @author :liw &lt;liweilijie@gmail.com&gt;
 * @version 0.0.0.1
 * @date 2011-08-14
 */
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

/**
 * @brief dynamic_array_new &lt;++&gt; dynamic create two-dimensional array.
 *
 * @param row&lt;++&gt; row of two-dimensional array.
 * @param col&lt;++&gt; col of two-dimensional array.
 * @param size&lt;++&gt; size of every member into array.
 *
 * @return : success: return array poine; fail: NULL.
 */
void **dynamic_array_new(int row, int col, int size)
{
	if (0 == size || 0 == row || 0 == col)
		return NULL;

	void **arr;

	/**
	 * malloc the memory to store the two-dimensional array members.
	 * but added the row pointer memory to pointer the every array row member  address.
	 */
	arr = (void **)malloc(size * row * col);

	if (NULL != arr)
	{
		/** void *head;*/
		
		/** head = (void *)arr + sizeof(void *)*row; [&gt;find the data member address. &lt;] */
		/** memset(arr, 0, sizeof(void *) * row + size * row * col); [&gt;initializal all memory . &lt;] */
		memset(arr, 0, size * row * col); /** initializal all memory . */

		/** while (row--)*/
			/** arr[row] = head + size * row * col; [&gt;to find the every tow-dimensional array row address &lt;] */
	}
	else
		return NULL;

	return arr;
}

/**
 * @brief dynamic_array_free &lt;++&gt; just free the malloc momery.
 *
 * @param arr&lt;++&gt; the pointer by malloc.
 */
void dynamic_array_free(void **arr)
{
	if (arr != NULL)
		free(arr);
}


/**
 * @brief main &lt;++&gt; the test coder about tow-dimensional to dynamic create.
 *
 * @param argc&lt;++&gt; NULL.
 * @param argv[]&lt;++&gt; NULL.
 *
 * @return : always 0.
 */
int main(int argc, char *argv[])
{
	int i, j;

	struct _tt
	{
		int index; /** to pointer the two-dimensional array row */ 
		int value;  /** to store the value but this to use the col value  */ 
	};
	typedef struct _tt (*yy)[4];

	/** TODO(1st): malloc the two-dimensional need memory. */ 
	/** struct _tt (*array)[20] = dynamic_array_new(5, 4, sizeof(struct _tt));*/
	yy array = (yy)dynamic_array_new(5, 4, sizeof(struct _tt));
	

	/** TODO(2st): get the value for the every array member. */
	for (i = 0; i &lt; 5; i++)
	{
		for (j = 0; j &lt; 4; j++)
		{
			array[i][j].index = i+1;
			array[i][j].value = j+1;
		}
	}

	/** TODO(3st): print the every value like array. */
	for (i = 0; i &lt; 5; i++)
	{
		for (j = 0; j &lt; 4; j++)
		{
			printf("ray[%d][%d].index=%1d ", i, j, array[i][j].index);
			printf("ray[%d][%d].value=%1d ", i, j, array[i][j].value);
		}
		printf("\n");
	}
	
	/** TODO(4st): free the memory while program is exiting due to it is heep. */
	dynamic_array_free(array);

	return 0;
}
</pre>

<p>
<em>结果如下：</em>
</p>
<pre class="brush:bash; collapse: true;">
liwei@liweilijie test$ vim d_n.c 
liwei@liweilijie test$ gcc -Wall -g -o d d_n.c 
d_n.c: 在函数‘main’中:
d_n.c:96:13: 警告：从不兼容的指针类型初始化 [默认启用]
d_n.c:121:2: 警告：传递‘dynamic_array_free’的第 1
个参数时在不兼容的指针类型间转换 [默认启用]
d_n.c:66:6: 附注：需要类型‘void **’，但实参的类型为‘yy’
liwei@liweilijie test$ ./d
ray[0][0].index=1 ray[0][0].value=1 ray[0][1].index=1 ray[0][1].value=2
ray[0][2].index=1 ray[0][2].value=3 ray[0][3].index=1 ray[0][3].value=4 
ray[1][0].index=2 ray[1][0].value=1 ray[1][1].index=2 ray[1][1].value=2
ray[1][2].index=2 ray[1][2].value=3 ray[1][3].index=2 ray[1][3].value=4 
ray[2][0].index=3 ray[2][0].value=1 ray[2][1].index=3 ray[2][1].value=2
ray[2][2].index=3 ray[2][2].value=3 ray[2][3].index=3 ray[2][3].value=4 
ray[3][0].index=4 ray[3][0].value=1 ray[3][1].index=4 ray[3][1].value=2
ray[3][2].index=4 ray[3][2].value=3 ray[3][3].index=4 ray[3][3].value=4 
ray[4][0].index=5 ray[4][0].value=1 ray[4][1].index=5 ray[4][1].value=2
ray[4][2].index=5 ray[4][2].value=3 ray[4][3].index=5 ray[4][3].value=4 
liwei@liweilijie test$ 

</pre>

							</div>
						</div>
					</div> <!-- really content end -->

					<div class="row footer">
						<hr />
						<a href="index.html">首页</a>
						<a href="#"> | 关于</a>
						<a href="#"> | 链接</a>
						<a href="#"> | 链接</a>
					</div>

				</div>

				<!-- Le javascript ================================================== -->
				<!-- Placed at the end of the document so the pages load faster -->
				<!-- display by liw <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>-->
				<!--<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>-->
				<script src="assets/js/jquery.js"></script>
				<script src="assets/js/google-code-prettify/prettify.js"></script>
				<script src="assets/js/bootstrap-transition.js"></script>
				<script src="assets/js/bootstrap-alert.js"></script>
				<script src="assets/js/bootstrap-modal.js"></script>
				<script src="assets/js/bootstrap-dropdown.js"></script>
				<script src="assets/js/bootstrap-scrollspy.js"></script>
				<script src="assets/js/bootstrap-tab.js"></script>
				<script src="assets/js/bootstrap-tooltip.js"></script>
				<script src="assets/js/bootstrap-popover.js"></script>
				<script src="assets/js/bootstrap-button.js"></script>
				<script src="assets/js/bootstrap-collapse.js"></script>
				<script src="assets/js/bootstrap-carousel.js"></script>
				<script src="assets/js/bootstrap-typeahead.js"></script>
				<script src="assets/js/application.js"></script>
				<script src="assets/js/liwei.js"></script>


			</body>
		</html>
