<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>liwei.tk</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="李伟">
		<meta name="author" content="李伟的维基">

		<!-- Le styles -->
		<link href="assets/css/bootstrap.css" rel="stylesheet">
		<link href="assets/css/bootstrap-responsive.css" rel="stylesheet">
		<!-- display by liw for the padding at the top <link href="assets/css/docs.css" rel="stylesheet">-->
		<link href="assets/css/docs.css" rel="stylesheet">
		<link href="style.css" rel="stylesheet">
		<link href="assets/js/google-code-prettify/prettify.css" rel="stylesheet">

		<!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
		<![endif]-->

		<!-- Le fav and touch icons -->
		<link rel="shortcut icon" href="../assets/ico/favicon.ico">
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
		<link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">

		<link type="text/css" rel="stylesheet" href="syntaxhighlighter/css/shCore.css" /> 
		<link type="text/css" rel="stylesheet" href="syntaxhighlighter/css/shThemeRDark.css" /> 
		<script type="text/javascript" src="syntaxhighlighter/js/shCore.js"></script> 
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPython.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushBash.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushCpp.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPowerShell.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushXml.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushPlain.js"></script>
		<script type="text/javascript" src="syntaxhighlighter/js/shBrushSql.js"></script>
		<script type="text/javascript">
			SyntaxHighlighter.defaults['gutter'] = true;
			SyntaxHighlighter.all();
			</script> 
			
<!-- add the google analytics -->
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-25233855-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

		</head>

		<body data-spy="scroll" data-target=".subnav" data-offset="50">

			<!--<div class="span10 well pricehover">-->

				<!-- ==================== start navbar ================== -->
				<div class="navbar">
					<div class="navbar-inner">
						<div class="container-fuid">
							<!-- old is : <div class="container"> and fixed by to 'fuid style' -->
								<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
									<span class="icon-bar"></span>
								</a>
								<a class="brand" href="#">Liwei.tk</a>
								<div class="nav-collapse">
									<ul class="nav">
										<li><a href="index.html">Home</a></li>
										<!-- Program sub projects  -->
										<li class="dropdown active">
										<a href="index.html#" class="dropdown-toggle" data-toggle="dropdown">Programs <b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="c.html">C</a></li>
											<li><a href="cpp.html">Cpp</a></li>
											<li><a href="shell.html">Shell</a></li>
											<li class="divider"></li>
											<li class="nav-header">Others</li>
											<li><a href="python.html">Python</a></li>
											<li><a href="expect.html">Expect</a></li>
											<li><a href="vc.html">Vc</a></li>
										</ul>
										</li>
										<!-- Os sub projects  -->
										<li class="dropdown">
										<a href="index.html#" class="dropdown-toggle" data-toggle="dropdown">Os <b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="linux.html">Linux</a></li>
											<li class="divider"></li>
											<li><a href="windows.html">Windows</a></li>
										</ul>
										</li>

										<!-- vim -->
										<li><a href="vim.html">Vim</a></li>
										<li><a href="#">Link</a></li>
										<li><a href="#">Link</a></li>
										<li class="dropdown">
										<a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="#">Action</a></li>
											<li><a href="#">Another action</a></li>
											<li><a href="#">Something else here</a></li>
											<li class="divider"></li>
											<li class="nav-header">Nav header</li>
											<li><a href="#">Separated link</a></li>
											<li><a href="#">One more separated link</a></li>
										</ul>
										</li>
									</ul>
									<form class="navbar-search pull-left" action="">
										<input type="text" class="search-query span2" placeholder="Search">
									</form>
									<ul class="nav pull-right">
										<li><a href="#">Link</a></li>
										<li class="divider-vertical"></li>
										<li class="dropdown">
										<a href="#" class="dropdown-toggle" data-toggle="dropdown">随记<b class="caret"></b></a>
										<ul class="dropdown-menu">
											<li><a href="article_by_my_heart.html">随心所欲</a></li>
											<li><a href="article_reading_notes.html">读书札记</a></li>
											<li><a href="article_love_music.html">最爱音乐</a></li>
											<li class="divider"></li>
											<li><a href="#">日记</a></li>
										</ul>
										</li>
									</ul>
								</div><!-- /.nav-collapse -->
							</div>
						</div><!-- /navbar-inner -->
					</div><!-- /navbar -->
					<!--</div>-->

				<div class="container">

					<!--span2 + span10 that's really content-->
					<div class="row">

						<!--left nav-->
						<div class="span3 side-nav">
							<div class="well sidebar-nav">
								<h3><a href="c.html">C</a></h3>

								<ul class="nav nav-pills nav-stacked">
									<li class="nav-header">关于语法</li>
									<li> <a href="c_cycle_single_link.html">单循环链表的实现</a></li>
									<li> <a href="c_util_function_interfaces.html">util function interface</a></li>
									<li> <a href="c_easy_error.html">只有两行的C程序至少有80%的人会判断错</a></li>
									<li> <a href="c_variable_length_array.html">c柔性数组</a></li>
									<li> <a href="c_counting_1_bits_c_implementations.html">计数一个整数中1的个数</a>
									<li> <a href="c_memory_manager_detail.html">c内存管理</a></li>
									<li> <a href="c_sscanf_detail.html">sscanf用法</a></li>
									<li> <a href="c_sizeof_about_point.html">sizeof(指针)</a><li>
									<li><a href="c_about_userlogin_api.html">c(api)实现用户登录信息</a></li>
									<li class="nav-header">常用实例</li>
									<li> <a href="c_debug_pthread_rwlock_t.html">compile时提示缺少pthread_rwlock_t类型定义</a></li> 
									<li> <a href="c_debug_memcmp_struct.html">小心使用memcmp来比较struct</a></li>
									<li> <a href="c_do_while_replase_if.html">用do...while(0)替代if多重判断</a></li>
									<li> <a href="c_gettimeofday_backup_time.html">c利用gettimeofday得到精确时间</a></li>
									<li> <a href="c_dynamic_two_dimensional_array.html">c动态申请二维数组</a></li>
									<li> <a href="c_program_analyse_deeply.html">c语言深度剖析</a></li>
									<li> <a href="c_macro_define_collect.html">c宏定义</a></li>
									<li> <a href="c_changable_agrument.html">c可变参数</a></li>
									<li class="nav-header">常用技巧</li>
									<li> <a href="c_function_argument.html">linux c 函数参考</a></li>
									<li> <a href="c_error.html">错误处理</a></li>
									<li> <a href="c_string.h.html">string.h 函数大全</a></li>
									<li> <a href="c_rand.html">c rand()</a></li>
									<li> <a href="c_diff_memcpy_memmove.html"> memcpy() memmove() 区别</a></li>
									<li> <a href="c_iconv_match_notice.html">慎用c语言中的iconv()</a></li>
								</ul>
							</div> <!-- ...well -->
						</div> <!-- --span  -->

						<!-- right contnet -->

						<div class="span9" data-spy="scroll" >
							<div class="gsearch"></div>
							<div class="content">
								<div class="alert top-nav"><a href="index.html">首页</a>&nbsp;&gt;&nbsp;<a href="c.html">C</a></div>
								
<h1>慎用c语言中的iconv()</h1>
<div class="toc">
<ul>
<li><a href="#toc_0.0.0.1">原谅我这一生不羁放纵爱自由</a>
<li><a href="#toc_0.0.0.2">神奇的strstr()</a>
<li><a href="#toc_0.0.0.3">当转换编码出错时继续匹配问题</a>
</ul>
</ul>
</ul>
</ul>
</div>

<h4 id="toc_0.0.0.1">原谅我这一生不羁放纵爱自由</h4>
<p>
<em>我只是想说依旧深爱着我的linux,我的c,我的vim, 因为我享受着他们，自由自在地进着人生地每一步</em>
</p>

<p>
今天在程序里面发现一个bug,这有待上层提供线索，找到这个问题让我明白是为什么会有这样的问题。
</p>

<p>
在这里想说匹配字符串尤其是转化编码之后再匹配时一定要慎用字符串函数。
</p>

<h4 id="toc_0.0.0.2">神奇的strstr()</h4>
<p>
先看它给的神奇manpage是如何的欺骗我们的：
</p>
<pre class="brush:plain; collapse: true; Title: manpages;">
STRSTR(3)                  Linux Programmer’s Manual                 STRSTR(3)

NAME
       strstr - locate a substring

SYNOPSIS
       #include &lt;string.h&gt;

       char *strstr(const char *haystack, const char *needle);

DESCRIPTION
       The  strstr() function finds the first occurrence of the substring nee-
       dle in the string haystack.  The terminating ‘\0’  characters  are  not
       compared.

RETURN VALUE
       The  strstr()  function  returns a pointer to the beginning of the sub-
       string, or NULL if the substring is not found.

BUGS
       Early versions of Linux libc (like 4.5.26) would  not  allow  an  empty
       argument.  Later  versions  (like  4.6.27)  work  correctly, and return
       haystack when needle is empty.

CONFORMING TO
       ISO 9899

SEE ALSO
       index(3), memchr(3), rindex(3), strchr(3), strpbrk(3), strsep(3),  str-
       spn(3), strtok(3)

GNU                               1993-04-12                         STRSTR(3)

</pre>

<ul>
<li>
它这里说到'\0'情况下，如果这里要匹配的内容第一个就是'\0'它会如何处理呢？

<li>
它这里也说到empty,这里的empty是指NULL的意思吗？

</ul>

<p>
测试代码：
</p>
<pre class="brush:c;">

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;

int main(int argc, char *argv[])
{
	char a[20] = "abcdef123";
	char b[10];
	char *p = NULL, *t = NULL;
	memset(b, '\0', sizeof b);

	/**
	 * if the string is empty
	 * and the values is 0
	 * so it can to match
	 */
	if ((p = strstr(a, b)) != NULL)
		printf("success strstr a:&lt;%s&gt; &amp;&amp; b:&lt;%s&gt; and p:&lt;%s&gt;\n", a, b, p);
	else
		printf("failed strstr a:&lt;%s&gt; &amp;&amp; b:&lt;%s&gt;\n", a, b);

	/**
	 * if the match string is NULL and core dump
	 * to exit()
	 */
	if ((p = strstr(a, t)) != NULL)
		printf("success strstr \n");
	else
		printf("failed strstr\n");

	return 0;
}
</pre>

<p>
结果：
</p>
<pre class="brush:bash;">
gcc -Wall -g -o strstr strstr.c
[root@liwei wjpt_test]# ./strstr 
success strstr a:&lt;abcdef123&gt; &amp;&amp; b:&lt;&gt; and p:&lt;abcdef123&gt;
段错误
</pre>



<p>
strstr的实现:
</p>
<pre class="brush:c;">
typedef unsigned chartype;

char *
strstr (phaystack, pneedle)
     const char *phaystack;
     const char *pneedle;
{
	const unsigned char *haystack, *needle;
	chartype b;
	const unsigned char *rneedle;

	haystack = (const unsigned char *) phaystack;

/*
 * 在这里如果pneedle里面的内容为'\0'那么b==0,这个时候if不成立直接 goto foundneedle
 * 于是返回的内容不是NULL认为匹配到。
 * 
 * 这么大的问题为什么不在manpage里面写明白呢？
 */
	if ((b = *(needle = (const unsigned char *) pneedle)))
	{
		chartype c;
		haystack--;		/* possible ANSI violation */

		{
			chartype a;
			do
				if (!(a = *++haystack))
					goto ret0;
			while (a != b);
		}

		if (!(c = *++needle))
			goto foundneedle;
		++needle;
		goto jin;

		for (;;)
		{
			{
				chartype a;
				if (0)
					jin:{
						if ((a = *++haystack) == c)
							goto crest;
					}
				else
					a = *++haystack;
				do
				{
					for (; a != b; a = *++haystack)
					{
						if (!a)
							goto ret0;
						if ((a = *++haystack) == b)
							break;
						if (!a)
							goto ret0;
					}
				}
				while ((a = *++haystack) != c);
			}
crest:
			{
				chartype a;
				{
					const unsigned char *rhaystack;
					if (*(rhaystack = haystack-- + 1) == (a = *(rneedle = needle)))
						do
						{
							if (!a)
								goto foundneedle;
							if (*++rhaystack != (a = *++needle))
								break;
							if (!a)
								goto foundneedle;
						}
						while (*++rhaystack == (a = *++needle));
					needle = rneedle;	/* took the register-poor aproach */
				}
				if (!a)
					break;
			}
		}
	}
foundneedle:
	return (char *) haystack;
ret0:
	return 0;
}
</pre>



<h4 id="toc_0.0.0.3">当转换编码出错时继续匹配问题</h4>
<pre class="brush:c;">

#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;iconv.h&gt;

char iconv_utf8_gb2312(char *to, int to_len, char *from, int from_len);


typedef struct _match
{
	char match1[64];
	char gb2312_match1[128];
}match_type;

#define ICONV_MATCH(a,b) \
{\
	if (strcmp(a.b, "NONE"))\
		iconv_utf8_gb2312(a.gb2312_##b, 128, a.b, 64);\
}\

char iconv_utf8_gb2312(char *to, int to_len, char *from, int from_len)
{
  iconv_t   cd;
  int       _to_len, _from_len;

  cd = iconv_open("GB2312", "UTF-8");
  if ((int)cd == -1)
    return 0;
  _to_len = to_len;
  _from_len = from_len + 1;
  iconv(cd, &amp;from, &amp;_from_len, &amp;to, &amp;_to_len);
  iconv_close(cd);

  return 1;
}

int main(void)
{
	match_type match_test;
	memset(&amp;match_test, '\0', sizeof(match_type));
	strncpy(match_test.match1, "買到槍", strlen("買到槍"));
	/** strncpy(match_test.match1, "卖到枪", strlen("卖到枪"));*/

	ICONV_MATCH(match_test, match1);
	printf("utf8:&lt;%s&gt; &amp;&amp;gd2312:&lt;%s&gt;\n", match_test.match1, match_test.gb2312_match1);

	printf("start to match1....\n");
	char tmp_string[1024] = "Libnet核心数据结构 -  AlphaJay的个人空间 - 开源中";
	if (strstr(tmp_string, match_test.match1) != NULL)
		printf("success match1:&lt;%s&gt; &amp;&amp; tmp_string: &lt;%s&gt;\n", match_test.match1, tmp_string);
	else
		printf("failed match1:&lt;%s&gt; &amp;&amp; tmp_string: &lt;%s&gt;\n", match_test.match1, tmp_string);

	printf("start to gb2312_match1....\n");
	if (strstr(tmp_string, match_test.gb2312_match1) != NULL)
		printf("success match1:&lt;%s&gt; &amp;&amp; tmp_string: &lt;%s&gt;\n", match_test.gb2312_match1, tmp_string);
	else
		printf("failed match1:&lt;%s&gt; &amp;&amp; tmp_string: &lt;%s&gt;\n", match_test.gb2312_match1, tmp_string);

	return 0;
}
</pre>

<p>
result:
</p>
<pre class="brush:bash;">
gcc -Wall -g -o iconv_match iconv_match.c
[root@liwei wjpt_test]# ./iconv_match 
utf8:&lt;買到槍&gt; &amp;&amp;gd2312:&lt;&gt;
start to match1....
failed match1:&lt;買到槍&gt; &amp;&amp; tmp_string: &lt;Libnet核心数据结构 -  AlphaJay的个人空间 - 开源中&gt;
start to gb2312_match1....
success match1:&lt;&gt; &amp;&amp; tmp_string: &lt;Libnet核心数据结构 -  AlphaJay的个人空间 - 开源中&gt;
[root@liwei wjpt_test]# vim iconv_match.c 
[root@liwei wjpt_test]# make



gcc -Wall -g -o iconv_match iconv_match.c
[root@liwei wjpt_test]# ./iconv_match 
utf8:&lt;卖到枪&gt; &amp;&amp;gd2312:&lt;����ǹ&gt;
start to match1....
failed match1:&lt;卖到枪&gt; &amp;&amp; tmp_string: &lt;Libnet核心数据结构 -  AlphaJay的个人空间 - 开源中&gt;
start to gb2312_match1....
failed match1:&lt;����ǹ&gt; &amp;&amp; tmp_string: &lt;Libnet核心数据结构 -  AlphaJay的个人空间 - 开源中&gt;
[root@liwei wjpt_test]# vim iconv_match.c 
</pre>

							</div>
						</div>
					</div> <!-- really content end -->

					<div class="row footer">
						<hr />
						<a href="index.html">首页</a>
						<a href="#"> | 关于</a>
						<a href="#"> | 链接</a>
						<a href="#"> | 链接</a>
					</div>

				</div>

				<!-- Le javascript ================================================== -->
				<!-- Placed at the end of the document so the pages load faster -->
				<!-- display by liw <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>-->
				<!--<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>-->
				<script src="assets/js/jquery.js"></script>
				<script src="assets/js/google-code-prettify/prettify.js"></script>
				<script src="assets/js/bootstrap-transition.js"></script>
				<script src="assets/js/bootstrap-alert.js"></script>
				<script src="assets/js/bootstrap-modal.js"></script>
				<script src="assets/js/bootstrap-dropdown.js"></script>
				<script src="assets/js/bootstrap-scrollspy.js"></script>
				<script src="assets/js/bootstrap-tab.js"></script>
				<script src="assets/js/bootstrap-tooltip.js"></script>
				<script src="assets/js/bootstrap-popover.js"></script>
				<script src="assets/js/bootstrap-button.js"></script>
				<script src="assets/js/bootstrap-collapse.js"></script>
				<script src="assets/js/bootstrap-carousel.js"></script>
				<script src="assets/js/bootstrap-typeahead.js"></script>
				<script src="assets/js/application.js"></script>
				<script src="assets/js/liwei.js"></script>


			</body>
		</html>
